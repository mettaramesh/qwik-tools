async function Te(u,ye){try{const e=await fetch("/textComparer.html");if(!e.ok)throw new Error(`Failed to load Text Comparer HTML: ${e.status}`);const t=await e.text();if(t.includes("<!DOCTYPE html")||t.includes("<html"))throw new Error("Invalid HTML content - contains full page structure");u.innerHTML=t}catch(e){console.error("Error loading Text Comparer:",e),u.innerHTML='<div class="error">Failed to load Text Comparer tool</div>';return}await new Promise(e=>setTimeout(e,10));const f=u.querySelector("#tc-text1"),d=u.querySelector("#tc-text2"),p=u.querySelector("#gutter-left"),g=u.querySelector("#gutter-right"),D=u.querySelector("#tc-compare"),P=u.querySelector("#tc-clear"),z=u.querySelector("#tc-copy"),v=u.querySelector("#tc-result"),M=u.querySelector("#tc-status"),E=u.querySelector("#tc-similarity"),ae=u.querySelector("#tc-result-meta"),W=u.querySelector("#tc-search"),X=u.querySelector("#tc-search-prev"),J=u.querySelector("#tc-search-next"),V=u.querySelector("#tc-word-level"),G=u.querySelector("#tc-ignore-ws"),K=u.querySelector("#tc-ignore-case"),U=u.querySelector("#tc-show-lines"),$=u.querySelector("#splitter"),Y=u.querySelector("#tc-main"),R=u.querySelector("#left-wrap"),Q=u.querySelector("#right-wrap");if(!f||!d||!v||!M){console.error("Text Comparer: Missing essential DOM elements"),console.error("Debug info:",{"t1 (tc-text1)":!!f,"t2 (tc-text2)":!!d,"resultEl (tc-result)":!!v,"statusEl (tc-status)":!!M,containerHTML:u.innerHTML.length+" chars",containerChildrenCount:u.children.length}),u.innerHTML='<div class="error">Failed to initialize Text Comparer - missing elements</div>';return}function y(e,t=!0){M.textContent=e,M.classList.remove("status-ok","status-error"),M.classList.add(t?"status-ok":"status-error")}function j(e){ae.textContent=e||""}function m(e){return String(e).replace(/[&<>]/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;"})[t])}function fe(e){return String(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function b(e){const t=window.getComputedStyle(e);let n=parseFloat(t.lineHeight);if(isNaN(n)||t.lineHeight==="normal"){const r=parseFloat(t.fontSize)||13;n=Math.round(r*1.45)}return Math.round(n)}function Z(e,t,n){const r=e.children.length;if(r>t)for(let i=r-1;i>=t;i--)e.removeChild(e.children[i]);else if(r<t){const i=document.createDocumentFragment();for(let s=r;s<t;s++){const l=document.createElement("div");l.className="ln",i.appendChild(l)}e.appendChild(i)}for(let i=0;i<t;i++){const s=e.children[i],l=String(i+1);s.textContent!==l&&(s.textContent=l),s.style.height=n+"px",s.style.lineHeight=n+"px"}}function k(){const e=Math.max(1,f.value.split(`
`).length),t=Math.max(1,d.value.split(`
`).length),n=b(f),r=b(d);Z(p,e,n),Z(g,t,r),U.checked?(p.classList.remove("hidden"),g.classList.remove("hidden")):(p.classList.add("hidden"),g.classList.add("hidden"))}function _(e,t){if(t<=0)return 0;let n=0;for(let r=0;r<t;r++){const i=e.indexOf(`
`,n);if(i===-1){n=e.length;break}n=i+1}return n}function ee(e,t){return t.wordLevel?e.split(/(\s+|\b)/).map(n=>n===void 0?"":n):e.split("")}function te(e,t){let n=String(e);return t.ignoreWs&&(n=n.replace(/\s+/g,"")),t.ignoreCase&&(n=n.toLowerCase()),n}function de(e,t,n){const r=e.length,i=t.length,s=Array(r+1).fill(null).map(()=>Array(i+1).fill(0));for(let l=r-1;l>=0;l--)for(let o=i-1;o>=0;o--)s[l][o]=n(e[l],t[o])?1+s[l+1][o+1]:Math.max(s[l+1][o],s[l][o+1]);return s}function ne(e,t,n){const r=ee(e,n),i=ee(t,n),s=(h,L)=>te(h,n)===te(L,n),l=de(r,i,s);let o=0,a=0,c="";for(;o<r.length||a<i.length;)o<r.length&&a<i.length&&s(r[o],i[a])?(c+=m(String(i[a])),o++,a++):a<i.length&&(o===r.length||l[o][a+1]>=l[o+1][a])?(c+=`<span class="diff-add">${m(String(i[a]))}</span>`,a++):o<r.length&&(a===i.length||l[o][a+1]<l[o+1][a])?(c+=`<span class="diff-del">${m(String(r[o]))}</span>`,o++):(o<r.length&&(c+=`<span class="diff-del">${m(String(r[o]))}</span>`,o++),a<i.length&&(c+=`<span class="diff-add">${m(String(i[a]))}</span>`,a++));return c}function re(e){if(!e||!e.trim())return null;const t=e.trim();if(t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]"))try{return JSON.stringify(JSON.parse(t),null,2)}catch{}if(t.startsWith("<"))try{const r=new DOMParser().parseFromString(t,"application/xml");if(!r.querySelector("parsererror"))return ue(r)}catch{}return null}function ue(e){function t(n,r=""){if(n.nodeType===3){const a=n.nodeValue.trim();return a?r+m(a)+`
`:""}if(n.nodeType===8)return r+"<!--"+m(n.nodeValue)+`-->
`;if(n.nodeType!==1)return"";const i=n.nodeName;let s="";if(n.attributes&&n.attributes.length)for(let a=0;a<n.attributes.length;a++){const c=n.attributes[a];s+=` ${c.name}="${m(c.value)}"`}const l=Array.from(n.childNodes||[]);if(!l.length)return r+`<${i}${s}/>
`;const o=l.map(a=>t(a,r+"  ")).join("");return r+`<${i}${s}>
`+o+r+`</${i}>
`}return Array.from(e.childNodes).map(n=>t(n,"")).join("")}function he(e,t,n){const r=e.length,i=t.length;if(r===0||i===0)return{dp:[],n:r,m:i};const s=Array(r+1).fill(null).map(()=>Array(i+1).fill(0));for(let l=r-1;l>=0;l--)for(let o=i-1;o>=0;o--)s[l][o]=n(e[l],t[o])?1+s[l+1][o+1]:Math.max(s[l+1][o],s[l][o+1]);return{dp:s,n:r,m:i}}function pe(e,t,n={}){const r=re(e)||e,i=re(t)||t,s=r.split(`
`),l=i.split(`
`),o=(w,I)=>{if(!n.ignoreWs&&!n.ignoreCase)return w===I;const oe=n.ignoreWs?w.replace(/\s+/g,""):w,ce=n.ignoreWs?I.replace(/\s+/g,""):I;return n.ignoreCase?oe.toLowerCase()===ce.toLowerCase():oe===ce},{dp:a}=he(s,l,o);let c=0,h=0,L="";for(;c<s.length||h<l.length;)if(c<s.length&&h<l.length&&o(s[c],l[h]))L+=`<div class="diff-line">${m(s[c])}</div>`,c++,h++;else if(h<l.length&&(c===s.length||a[c][h+1]>=a[c+1][h]))if(n.wordLevel&&c<s.length){const w=ne(s[c],l[h],n);L+=`<div class="diff-line">${w}</div>`,c++,h++}else L+=`<div class="diff-line"><span class="diff-add">${m(l[h])}</span></div>`,h++;else if(c<s.length&&(h===l.length||a[c][h+1]<a[c+1][h]))if(n.wordLevel&&h<l.length){const w=ne(s[c],l[h],n);L+=`<div class="diff-line">${w}</div>`,c++,h++}else L+=`<div class="diff-line"><span class="diff-del">${m(s[c])}</span></div>`,c++;else c<s.length&&(L+=`<div class="diff-line"><span class="diff-del">${m(s[c])}</span></div>`,c++),h<l.length&&(L+=`<div class="diff-line"><span class="diff-add">${m(l[h])}</span></div>`,h++);return{html:L,leftFormatted:r,rightFormatted:i}}function ge(e,t){const n=e.replace(/\s+/g,""),r=t.replace(/\s+/g,"");if(!n&&!r)return 100;const i=Math.min(n.length,r.length);let s=0;for(let l=0;l<i;l++)n[l]===r[l]&&s++;return Math.round(s/Math.max(n.length,r.length)*100)}let H=null,N=!1;function C(e=140){H&&clearTimeout(H),H=setTimeout(()=>{N||(N=!0,requestAnimationFrame(()=>{A(),N=!1})),H=null},e)}let S=null,le=0,O=null;function me(){try{const e=new Worker("diff.worker.js");return y("Worker enabled"),e}catch{return y("Worker unavailable, using main thread",!1),null}}function ie(){if(S){try{S.terminate()}catch{}S=null}}function ve(e,t,n,r,i){if(S||(S=me()),!S){i&&i("Worker unavailable");return}le++;const s=le;S.postMessage({id:s,type:"compute",left:e,right:t,opts:n}),O=setTimeout(()=>{ie(),y("Worker timeout, using main thread",!1),i&&i("Worker timeout")},6e3),S.onmessage=l=>{!l.data||l.data.id!==s||(clearTimeout(O),l.data.type==="done"?r&&r(l.data.html,l.data.similarity,l.data.meta):l.data.type==="error"&&i&&i(l.data.message))},S.onerror=l=>{clearTimeout(O),ie(),y("Worker error, using main thread",!1),i&&i("Worker error")}}function A(e=!1){y("Computing diff...");const t=f.value,n=d.value,r={wordLevel:V.checked,ignoreWs:G.checked,ignoreCase:K.checked};ve(t,n,r,(i,s,l)=>{v.innerHTML=i||'<div class="tc-no-diff">No differences</div>',E.textContent=s?`Similarity: ${s}%`:"",j(l||""),y("Ready (worker)"),F()},i=>{const{html:s}=pe(t,n,r);v.innerHTML=s||'<div class="tc-no-diff">No differences</div>',E.textContent=`Similarity: ${ge(t,n)}%`,j(""),y("Ready (main thread)",!1),F()})}[V,G,K,U].filter(Boolean).forEach(e=>{e&&e.addEventListener("change",()=>{k(),C(60)})}),D&&D.addEventListener("click",()=>A(!0)),W&&W.addEventListener("input",()=>C(80)),z&&z.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(v.innerText||""),y("Result copied to clipboard")}catch{y("Copy failed",!1)}}),P&&P.addEventListener("click",()=>{f&&(f.value=""),d&&(d.value=""),v&&(v.innerHTML=""),k(),y("Cleared"),E&&(E.textContent=""),j(""),F()}),[f,d].filter(Boolean).forEach(e=>{e&&(e.addEventListener("input",()=>{k(),C()}),e.addEventListener("paste",()=>{setTimeout(()=>{k(),C()},20)}),e.addEventListener("keydown",t=>{(navigator.platform.toLowerCase().includes("mac")?t.metaKey:t.ctrlKey)&&t.key.toLowerCase()==="b"&&(t.preventDefault(),A())}))}),f&&d&&!f.value&&!d.value?(f.value=`The quick brown fox
jumps over the lazy dog.
This is the left file.
It has several lines.
Some lines will be changed.`,d.value=`The quick brown fox
jumps over the lazy dog!
This is the right file.
It has several lines.
Some lines will be added.
And some will be removed.`,k(),C(20)):(k(),C(20)),function(){if(!$||!R||!Q||!Y)return;let t=0,n=0;$.addEventListener("pointerdown",r=>{r.preventDefault(),t=r.clientX,n=R.getBoundingClientRect().width,$.setPointerCapture(r.pointerId);function i(l){const o=l.clientX-t,a=Y.clientWidth;let c=Math.max(200,Math.min(a-200,n+o));R.style.flex=`0 0 ${c}px`,Q.style.flex=`0 0 ${Math.max(200,a-c-$.offsetWidth)}px`}function s(l){$.releasePointerCapture(l.pointerId),document.removeEventListener("pointermove",i),document.removeEventListener("pointerup",s)}document.addEventListener("pointermove",i),document.addEventListener("pointerup",s)})}();function se(){f.addEventListener("scroll",()=>{p.scrollTop=f.scrollTop,Math.abs(d.scrollTop-f.scrollTop)>1&&(d.scrollTop=f.scrollTop),g.scrollTop=f.scrollTop},{passive:!0}),d.addEventListener("scroll",()=>{g.scrollTop=d.scrollTop,Math.abs(f.scrollTop-d.scrollTop)>1&&(f.scrollTop=d.scrollTop),p.scrollTop=d.scrollTop},{passive:!0}),p.addEventListener("click",e=>{const t=e.target.closest(".ln");if(!t)return;const n=Array.prototype.indexOf.call(p.children,t);q(f,n)}),g.addEventListener("click",e=>{const t=e.target.closest(".ln");if(!t)return;const n=Array.prototype.indexOf.call(g.children,t);q(d,n)})}se();function q(e,t){const n=_(e.value,t);e.focus(),e.setSelectionRange(n,n);const r=b(e);e.scrollTop=Math.max(0,t*r-e.clientHeight/2)}u.textComparer={update:A,getResultHtml:()=>v.innerHTML,getSimilarity:()=>E.textContent},y("Ready — checkboxes now applied to diff");let T=[],x=0;function F(){const e=(W.value||"").trim();let t=v.innerHTML;if(!e){v.innerHTML=t.replace(/<span class="diff-chg">(.*?)<\/span>/g,"$1"),T=[],x=0;return}t=t.replace(/<span class="diff-chg">(.*?)<\/span>/g,"$1");const n=new RegExp(fe(e),"gi");let r=0;t=t.replace(n,i=>(r++,`<span class="diff-chg" data-match-idx="${r-1}">${m(i)}</span>`)),v.innerHTML=t,T=Array.from(v.querySelectorAll(".diff-chg")),x=0,B()}function B(){if(!T.length)return;T.forEach((t,n)=>{t.style.outline=n===x?"2px solid #2563eb":"",t.style.background=n===x?"#fff4ce":""});const e=T[x];e&&e.scrollIntoView({behavior:"smooth",block:"center"})}W&&W.addEventListener("input",()=>{F()}),X&&X.addEventListener("click",()=>{T.length&&(x=(x-1+T.length)%T.length,B())}),J&&J.addEventListener("click",()=>{T.length&&(x=(x+1)%T.length,B())})}export{Te as load};
