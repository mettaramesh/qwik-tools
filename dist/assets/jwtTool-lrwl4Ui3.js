function _e(){const i=document.getElementById("jwt-css-link");i&&i.remove();const d=document.createElement("link");d.id="jwt-css-link",d.rel="stylesheet",d.type="text/css",d.href="/jwtTool.css?v="+Date.now(),document.head&&document.head.appendChild(d)}async function Ge(i){try{_e();const d=await fetch("jwtTool.html").then(p=>p.text());if(d.includes("<html>")||d.includes("<head>")||d.includes("<body>"))throw new Error("Invalid HTML content - contains full page structure");i.innerHTML=d}catch(d){console.error("Failed to load JWT tool HTML:",d),i.innerHTML='<div class="error">Failed to load JWT tool</div>'}}function Ye(){const i=e=>document.getElementById(e),d=i("jwt-input"),p=i("jwt-header"),y=i("jwt-payload"),m=i("jwt-signature"),g=i("jwt-secret"),J=i("jwt-pubkey"),x=i("jwt-jwks"),w=i("jwks-note"),A=i("jwt-status"),V=i("jwt-hints"),N=i("hdr-size"),L=i("pld-size"),U=i("jwt-skew"),B=i("jwt-claims-mode"),Q=i("jwt-auto"),he=i("gen-sub"),Se=i("gen-name"),me=i("gen-ttl"),we=i("gen-iat"),ke=i("gen-extra"),X=i("gen-button"),ee=i("gen-note"),be=i("kp-alg"),Ee=i("kp-ttl"),Ke=i("kp-sub"),xe=i("kp-name"),te=i("kp-generate"),P=i("kp-mint"),ne=i("kp-note"),M=i("kp-pub"),re=i("kp-priv"),k={iat:{local:i("hr-iat-local"),utc:i("hr-iat-utc"),rel:i("hr-iat-rel")},nbf:{local:i("hr-nbf-local"),utc:i("hr-nbf-utc"),rel:i("hr-nbf-rel")},exp:{local:i("hr-exp-local"),utc:i("hr-exp-utc"),rel:i("hr-exp-rel")}};let b={alg:null,privateKey:null,publicKey:null},v={keysByKid:new Map,list:[],parsed:!1};const C=new TextEncoder,Ce=new TextDecoder;function O(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function R(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4;)t+="=";const n=atob(t),r=new Uint8Array(n.length);for(let o=0;o<n.length;o++)r[o]=n.charCodeAt(o);return r}function $(e){return O(C.encode(JSON.stringify(e)))}function ie(e){return JSON.parse(Ce.decode(R(e)))}function z(e){return/^[A-Za-z0-9_-]+$/.test(e)&&e.length>0}function oe(e){for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>127)return!0;return!1}async function se(e){return crypto.subtle.importKey("raw",C.encode(e),{name:"HMAC",hash:"SHA-256"},!1,["sign","verify"])}async function ae(e,t){const n=await se(t),r=await crypto.subtle.sign("HMAC",n,C.encode(e));return O(new Uint8Array(r))}async function Je(e,t,n){const r=await se(n);return crypto.subtle.verify("HMAC",r,R(t),C.encode(e))}async function Ae(e,t){if(e.trim().startsWith("{")){const r=JSON.parse(e);return le(r,t)}else{const o=e.replace(/\r/g,"").trim().match(/-----BEGIN PUBLIC KEY-----([A-Za-z0-9+/=\n]+)-----END PUBLIC KEY-----/);if(!o)throw new Error("PEM must be SPKI with BEGIN PUBLIC KEY / END PUBLIC KEY");const u=Uint8Array.from(atob(o[1].replace(/\s+/g,"")),l=>l.charCodeAt(0));if(t==="RS256")return crypto.subtle.importKey("spki",u.buffer,{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"},!1,["verify"]);if(t==="ES256")return crypto.subtle.importKey("spki",u.buffer,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"]);throw new Error(`Unsupported alg for PEM: ${t}`)}}async function le(e,t){if(t==="RS256"){if(e.kty!=="RSA")throw new Error("JWK kty must be RSA for RS256");return crypto.subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"},!1,["verify"])}else if(t==="ES256"){if(e.kty!=="EC"||e.crv!=="P-256")throw new Error("JWK must be EC P-256 for ES256");return crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])}throw new Error(`Unsupported alg for JWK: ${t}`)}function Te(e){const t=e.slice(0,32),n=e.slice(32,64);function r(a){let s=0;for(;s<a.length-1&&a[s]===0;)s++;return a.slice(s)}function o(a){let s=r(a);return s[0]&128&&(s=Uint8Array.from([0,...s])),Uint8Array.from([2,s.length,...s])}const u=o(t),l=o(n),c=u.length+l.length;return Uint8Array.from([48,c,...u,...l])}function $e(e){let t=0;if(e[t++]!==48)throw new Error("Bad DER");if(t++,e[t++]!==2)throw new Error("Bad DER r");const n=e[t++],r=e.slice(t,t+n);if(t+=n,e[t++]!==2)throw new Error("Bad DER s");const o=e[t++],u=e.slice(t,t+o);function l(S){const h=new Uint8Array(32);return h.set(S,32-S.length),h}const c=l(r[0]===0?r.slice(1):r),a=l(u[0]===0?u.slice(1):u),s=new Uint8Array(64);return s.set(c,0),s.set(a,32),s}async function He(e,t,n,r){const o=typeof r=="string"?await Ae(r,n):await le(r,n),u=C.encode(e),l=R(t);if(n==="RS256")return crypto.subtle.verify({name:"RSASSA-PKCS1-v1_5"},o,l,u);if(n==="ES256"){const c=Te(l);return crypto.subtle.verify({name:"ECDSA",hash:"SHA-256"},o,c,u)}throw new Error(`Unsupported alg: ${n}`)}function F(){if(v={keysByKid:new Map,list:[],parsed:!1},!x)return;const e=(x.value||"").trim();if(!e){w&&(w.textContent="");return}try{const t=JSON.parse(e);if(!t||!Array.isArray(t.keys)){w&&(w.textContent='JWKS: expected an object with "keys" array.');return}t.keys.forEach(n=>{v.list.push(n),n.kid&&v.keysByKid.set(n.kid,n)}),v.parsed=!0,w&&(w.textContent=`JWKS loaded: ${v.list.length} key(s). ${v.keysByKid.size} with kid.`)}catch(t){w&&(w.textContent="JWKS parse error: "+t.message)}}function Ne(e,t){if(!v.parsed||v.list.length===0)return null;if(t&&v.keysByKid.has(t))return v.keysByKid.get(t);if(!t&&v.list.length===1){const r=v.list[0];if(!r.alg||r.alg===e)return r}return v.list.find(r=>!r.alg||r.alg===e)||null}function f(e,t){A&&(A.className=e==="ok"?"success-message":"error-message",A.textContent=t,A.classList.remove("hidden"))}function ce(){A&&(A.className="hidden",A.textContent="")}function _(e){V&&(V.textContent=e||"")}function T(e,t){try{const n=JSON.parse(e||"{}"),r=JSON.parse(t||"{}"),o=C.encode(JSON.stringify(n)).length,u=C.encode(JSON.stringify(r)).length;N&&(N.textContent=`Header size: ${o} bytes (UTF-8)`),L&&(L.textContent=`Payload size: ${u} bytes (UTF-8)`);const l=oe(JSON.stringify(n)),c=oe(JSON.stringify(r)),a=[];l&&a.push("Header contains non-ASCII (UTF-8 required)."),c&&a.push("Payload contains non-ASCII (UTF-8 required)."),_(a.join(" "))}catch{N&&(N.textContent=""),L&&(L.textContent=""),_("")}}function Le(e){return e?new Date(e*1e3).toLocaleString():"—"}function Pe(e){return e?new Date(e*1e3).toISOString().replace("T"," ").replace("Z"," UTC"):"—"}function We(e){if(!e)return"—";const t=Math.floor(Date.now()/1e3),n=e-t,r=Math.abs(n),o=Math.floor(r/3600),u=Math.floor(r%3600/60),l=r%60,c=o?`${o}h `:"",a=u?`${u}m `:"",s=`${l}s`;return n>=0?`in ${c}${a}${s}`.trim():`${c}${a}${s} ago`.trim()}function E(e){const t=["iat","nbf","exp"];for(const n of t){const r=e&&typeof e[n]=="number"?e[n]:null;k[n]&&k[n].local&&(k[n].local.textContent=Le(r)),k[n]&&k[n].utc&&(k[n].utc.textContent=Pe(r)),k[n]&&k[n].rel&&(k[n].rel.textContent=We(r))}}function je(){return Math.floor(Date.now()/1e3)}function De(){const e=parseInt(U.value,10);return Number.isFinite(e)&&e>=0?e:0}function Ie(){return B.value}function ue(e,t){const n=je(),r=[];let o=!0;return typeof e.exp=="number"&&n>e.exp+t&&(r.push("Token expired (exp)."),o=!1),typeof e.nbf=="number"&&n<e.nbf-t&&(r.push("Token not yet valid (nbf)."),o=!1),typeof e.iat=="number"&&e.iat>n+t&&(r.push("Issued-at (iat) is in the future."),o=!1),{ok:o,msgs:r}}async function fe(e){if(e&&(e.preventDefault(),e.stopPropagation()),!d||!p||!y||!m){console.warn("JWT tool: Missing required DOM elements for decoding");return}try{const t=(d.value||"").trim();if(T(p.value,y.value),!t){ce(),E(null);return}const n=t.split(".");if(![2,3].includes(n.length)||!z(n[0])||!z(n[1]))throw new Error("Invalid JWT structure or base64url segments.");const r=ie(n[0]);p.value=JSON.stringify(r,null,2);const o=ie(n[1]);if(y.value=JSON.stringify(o,null,2),T(p.value,y.value),E(o),n.length===3&&n[2]){if(!z(n[2]))throw new Error("Invalid signature encoding.");m.value=n[2]}else m.value="";const u=De(),l=Ie(),{ok:c,msgs:a}=ue(o,u);if(n.length===3&&n[2]){const s=r.alg;if(!s){f("err","Missing alg in header.");return}const S=n[0]+"."+n[1];let h=!1;if(s==="HS256"){if(!g.value){f("ok",W("JWT decoded (no HS256 secret provided)",a,l,c));return}h=await Je(S,n[2],g.value)}else if(s==="RS256"||s==="ES256"){const K=(J.value||"").trim();let H=null,D="";if(K)H=K,D="Public Key (manual)";else{const Z=r.kid,I=Ne(s,Z);I&&(H=I,D=I.kid?`JWKS (kid=${I.kid})`:"JWKS (single/fallback)")}if(!H){f("ok",W(`JWT decoded (${s} key not provided)`,a,l,c));return}try{h=await He(S,n[2],s,H)}catch(Z){f("err",`Key import failed: ${Z.message}`);return}if(!h){f("err",`Signature invalid (${D}).`);return}const Fe=`Signature valid (${s}, ${D})`;if(l==="enforce"&&!c){f("err","Signature valid but claims invalid: "+a.join(" "));return}f(l==="off"||c?"ok":"err",W(Fe,a,l,c))}else{f("err",`Unsupported alg="${s}". Only HS256, RS256, ES256 supported.`);return}if(s==="HS256"){if(!h){f("err","Signature invalid.");return}const K="Signature valid (HS256)";if(l==="enforce"&&!c){f("err","Signature valid but claims invalid: "+a.join(" "));return}f(l==="off"||c?"ok":"err",W(K,a,l,c))}}else if(r.alg&&r.alg!=="none")f("err",`Header alg="${r.alg}" but token is unsigned.`);else{const s="Unsigned JWT decoded";l==="enforce"&&!ue(o,u).ok?f("err",s+" but claims invalid."):f("ok",W(s,a,l,c))}}catch(t){f("err","Invalid JWT: "+t.message),p.value="",y.value="",m.value="",E(null)}}function W(e,t,n,r){if(n==="off"||t.length===0)return e;const o=" "+(r?"(claims OK)":"(claims warnings)")+" "+t.join(" ");return n==="warn"?e+o:n==="enforce"?e+(r?" (claims OK)":" (claims invalid) "+t.join(" ")):e}async function Ue(e){if(e&&(e.preventDefault(),e.stopPropagation()),!d||!p||!y||!m){console.warn("JWT tool: Missing required DOM elements for encoding");return}try{let t=(p.value||"").trim(),n=(y.value||"").trim();if(!t&&!n){f("err","Header and payload cannot both be empty.");return}t||(t='{"alg":"HS256","typ":"JWT"}'),n||(n='{"sub":"1234567890","name":"John Doe","iat":1516239022}');const r=JSON.parse(t),o=JSON.parse(n),u=!!(g&&g.value)||!!(J&&J.value);if(g&&g.value){if(r.alg&&r.alg!=="HS256")throw new Error(`Header alg="${r.alg}" incompatible with HS256 signing. Use "HS256".`);r.alg="HS256"}else r.alg||(r.alg="HS256");const l=$(r),c=$(o);let a="";g.value&&r.alg==="HS256"&&(a=await ae(l+"."+c,g.value));const s=l+"."+c+(a?"."+a:"");d.value=s,m.value=a,T(p.value,y.value),E(o),f("ok",a?"JWT encoded and signed (HS256)":"JWT encoded (no signature)")}catch(t){f("err","Encode error: "+t.message)}}function G(e,t={}){if(!e||!e.trim())return t;try{return JSON.parse(e)}catch{return t}}async function Be(e){e&&(e.preventDefault(),e.stopPropagation());try{const t=Math.floor(Date.now()/1e3),n=parseInt(me.value,10)||900,r=we.value==="yes",o=g.value&&g.value.length>0?g.value:"testsecret",u={sub:he.value||"demo-user",name:Se.value||"Alice Example",exp:t+n};r&&(u.iat=t);const l=G(ke.value,{}),c=Object.assign({},u,l),a={alg:"HS256",typ:"JWT"};p.value=JSON.stringify(a,null,2),y.value=JSON.stringify(c,null,2),T(p.value,y.value),E(c);const s=$(a),S=$(c),h=await ae(s+"."+S,o),K=`${s}.${S}.${h}`;d.value=K,m.value=h,ee.textContent=o==="testsecret"?'Signed with default secret "testsecret". For stronger tests, enter your own secret above.':"Signed with your HS256 secret.",f("ok","Sample JWT generated and signed (HS256).")}catch(t){f("err","Sample generation failed: "+t.message)}}async function Me(e){e&&(e.preventDefault(),e.stopPropagation());try{const t=be.value;let n;t==="RS256"?n=await crypto.subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},!0,["sign","verify"]):n=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"]),b={alg:t,privateKey:n.privateKey,publicKey:n.publicKey};const r=new Uint8Array(await crypto.subtle.exportKey("spki",n.publicKey)),o=new Uint8Array(await crypto.subtle.exportKey("pkcs8",n.privateKey));M.value=de(r,"PUBLIC KEY"),re.value=de(o,"PRIVATE KEY"),P.disabled=!1,ne.textContent=`Keypair ready (${t}). Use the public key to verify minted tokens.`,f("ok",`Generated ${t} keypair (ephemeral).`)}catch(t){f("err","Keypair generation failed: "+t.message),P.disabled=!0}}function de(e,t){const n=btoa(String.fromCharCode(...e)).match(/.{1,64}/g).join(`
`);return`-----BEGIN ${t}-----
${n}
-----END ${t}-----`}async function Oe(e){e&&(e.preventDefault(),e.stopPropagation());try{if(!b.privateKey||!b.publicKey||!b.alg){f("err","Generate a keypair first.");return}const t=b.alg,n=Math.floor(Date.now()/1e3),r=parseInt(Ee.value,10)||900,o={alg:t,typ:"JWT",kid:"ephem-1"},u={sub:Ke.value||"demo-user",name:xe.value||"Alice Example",iat:n,exp:n+r};p.value=JSON.stringify(o,null,2),y.value=JSON.stringify(u,null,2),T(p.value,y.value),E(u);const l=$(o),c=$(u),a=C.encode(`${l}.${c}`);let s;if(t==="RS256")s=new Uint8Array(await crypto.subtle.sign({name:"RSASSA-PKCS1-v1_5"},b.privateKey,a));else if(t==="ES256"){const H=new Uint8Array(await crypto.subtle.sign({name:"ECDSA",hash:"SHA-256"},b.privateKey,a));s=$e(H)}else throw new Error(`Unsupported alg for mint: ${t}`);const S=O(s),h=`${l}.${c}.${S}`;d.value=h,m.value=S;const K=await crypto.subtle.exportKey("jwk",b.publicKey);K.kid="ephem-1",Re(K),J.value=M.value,f("ok",`Minted ${t} token. Auto-added public JWK to JWKS (kid=ephem-1).`)}catch(t){f("err","Mint failed: "+t.message)}}function Re(e){let t;try{t=x.value.trim()?JSON.parse(x.value):{keys:[]}}catch{t={keys:[]}}Array.isArray(t.keys)||(t.keys=[]);const n=t.keys.findIndex(r=>r.kid&&e.kid&&r.kid===e.kid);n>=0?t.keys[n]=e:t.keys.push(e),x.value=JSON.stringify(t,null,2),F()}function ze(e){e&&(e.preventDefault(),e.stopPropagation()),d.value="",p.value="",y.value="",m.value="",g.value="",J.value="",x.value="",w.textContent="",M.value="",re.value="",b={alg:null,privateKey:null,publicKey:null},v={keysByKid:new Map,list:[],parsed:!1},ce(),_(""),E(null),N.textContent="",L.textContent="",ee.textContent="",ne.textContent="",P.disabled=!0}const pe=i("jwt-forget-secret");pe&&pe.addEventListener("click",e=>{e.preventDefault(),g.value=""});let Y=!1;["jwt-encode-btn","jwt-decode-btn","jwt-clear-btn","gen-button","kp-generate","kp-mint"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("mousedown",()=>{Y=!0})}),g&&g.addEventListener("blur",()=>{if(Y){Y=!1;return}g.value=""});const ye=i("jwt-decode-btn"),ge=i("jwt-encode-btn"),ve=i("jwt-clear-btn");ye&&ye.addEventListener("click",fe),ge&&ge.addEventListener("click",Ue),ve&&ve.addEventListener("click",ze),X&&X.addEventListener("click",Be),te&&te.addEventListener("click",Me),P&&P.addEventListener("click",Oe),x&&x.addEventListener("input",F);let q=null;function j(){!Q||Q.value==="off"||(q&&clearTimeout(q),q=setTimeout(()=>fe(),250))}d&&d.addEventListener("input",j),p&&p.addEventListener("input",()=>{T(p.value,y.value),E(G(y.value,{}))}),y&&y.addEventListener("input",()=>{T(p.value,y.value),E(G(y.value,{}))}),U&&U.addEventListener("change",j),B&&B.addEventListener("change",j),J&&J.addEventListener("input",j),g&&g.addEventListener("input",j),typeof window.setupCopyButtons=="function"&&window.setupCopyButtons(),F()}async function qe(i,d){await Ge(i),Ye()}export{qe as load,Ge as loadJWTTool,Ye as setupJWTTool};
