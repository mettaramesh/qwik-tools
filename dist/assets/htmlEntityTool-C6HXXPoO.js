async function X(w){const d=await fetch("src/htmlEntityTool.html").then(h=>h.text());w.innerHTML=d}function G(w){const d=e=>w.querySelector("#"+e),h=d("htmlInput"),p=d("htmlOutput"),g=d("btnEncode"),E=d("btnDecode"),P=d("btnClear"),j=d("btnCopy"),N=d("btnToggleView");d("htmlPreviewContainer");const v=d("htmlPreviewFrame"),C=d("htmlPreviewEscaped"),W=d("htmlPreviewCaption"),L=d("htmlStatus"),x=d("toggleNumericEncode"),A=d("sanitizationLevel");let k=!1,T="render";function y(e,t=!0,o=2500){L.textContent=e||"",L.style.color=t?"var(--color-success,#21808d)":"var(--color-error,#c0392b)",e?L.classList.remove("muted"):L.classList.add("muted"),o&&e&&setTimeout(()=>{L.textContent===e&&(L.textContent="",L.classList.add("muted"))},o)}function R(e){return e?navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(e).then(()=>!0).catch(()=>z(e)):Promise.resolve(z(e)):Promise.resolve(!1)}function z(e){try{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select();const o=document.execCommand&&document.execCommand("copy");return document.body.removeChild(t),!!o}catch{return!1}}function F(e){if(e==null)return"";const t=document.createElement("div");return t.appendChild(document.createTextNode(String(e))),t.innerHTML}function I(e){let t="";for(let o=0;o<e.length;o++){const u=e.charAt(o),f=e.charCodeAt(o);if(u==="&"){const n=e.indexOf(";",o);if(n>o){t+=e.slice(o,n+1),o=n;continue}}f>127?t+="&#x"+f.toString(16).toUpperCase()+";":t+=u}return t}function S(e,{toNumericNonAscii:t=!1}={}){const o=F(e);return t?I(o):o}function D(e){if(e==null)return"";const t=String(e);let o=t;if(/\<!doctype/i.test(t)||/<html[\s>]/i.test(t))try{const i=document.createElement("template");i.innerHTML=t;const a=i.content.querySelector("body");a?o=a.innerHTML:o=i.innerHTML}catch{o=t}if(!/[<>]/.test(o)&&!/&[a-zA-Z0-9#]+;/.test(o))return o.trim();const u=document.createElement("template");u.innerHTML=o;function f(i){if(i.nodeType===Node.TEXT_NODE)return i.nodeValue.replace(/\s+/g," ");if(i.nodeType!==Node.ELEMENT_NODE)return"";const a=i.tagName.toLowerCase(),m=new Set(["p","div","section","article","header","footer","aside","figure","figcaption","main","nav","address"]),l=new Set(["h1","h2","h3","h4","h5","h6"]);let r="";if(l.has(a))return r+=`
`+i.textContent.replace(/\s+/g," ").trim()+`

`,r;if(a==="br")return`
`;if(a==="hr")return`
---
`;if(a==="li"){if((i.parentElement&&i.parentElement.tagName.toLowerCase())==="ol"){const c=Array.prototype.indexOf.call(i.parentElement.children,i)+1;r+=`
`+c+". "}else r+=`
- `;for(const c of i.childNodes)r+=f(c);return r+=`
`,r}if(a==="ul"||a==="ol"){for(const s of i.childNodes)r+=f(s);return r+=`
`,r}if(a==="table"){const s=i.querySelectorAll("tr");for(const c of s){const Z=Array.from(c.children).map(B=>f(B).trim());r+=`
`+Z.join("	")+`
`}return r+=`
`,r}if(m.has(a)){r+=`
`;for(const s of i.childNodes)r+=f(s);return r+=`
`,r}if(a==="blockquote"){r+=`
> `;for(const s of i.childNodes)r+=f(s);return r+=`
`,r}if(a==="img"){const s=i.getAttribute("alt")||"",c=i.getAttribute("src")||"";return s?r+=`[img: ${s}]`:c?r+=`[img: ${c}]`:r+="[img]",r}for(const s of i.childNodes)r+=f(s);if(a==="a"){const s=i.getAttribute("href"),c=i.textContent.replace(/\s+/g," ").trim();if(s&&s.trim()&&c&&!c.includes(s))return c+" ("+s+")"}return r}let n="";for(const i of u.content.childNodes)n+=f(i);return n=n.replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim(),n}function _(e){const t=document.createElement("template");t.innerHTML=e;const o=new Set(["script","iframe","object","embed","link","meta"]),u=document.createTreeWalker(t.content,NodeFilter.SHOW_ELEMENT,null,!1),f=[];for(;u.nextNode();){const n=u.currentNode,i=n.tagName&&n.tagName.toLowerCase();if(o.has(i)){f.push(n);continue}const a=Array.from(n.attributes||[]);for(const m of a){const l=m.name.toLowerCase(),r=(m.value||"").toLowerCase();if(l.startsWith("on"))n.removeAttribute(m.name);else if((l==="href"||l==="src"||l==="xlink:href")&&r.trim().startsWith("javascript:"))n.removeAttribute(m.name);else if(l==="srcset")try{const s=m.value.split(",").map(c=>c.trim()).filter(c=>!c.toLowerCase().startsWith("javascript:"));s.length?n.setAttribute("srcset",s.join(", ")):n.removeAttribute("srcset")}catch{n.removeAttribute("srcset")}else l==="style"&&/expression\s*\(|javascript\s*:/i.test(m.value)&&n.removeAttribute("style")}}for(const n of f)n&&n.parentNode&&n.parentNode.removeChild(n);return t.innerHTML}function q(e){const t=document.createElement("template");t.innerHTML=e;const o=new Set(["script","iframe","object","embed","link","meta","form","input","button","select","textarea","video","audio","source","picture","svg"]),u=document.createTreeWalker(t.content,NodeFilter.SHOW_ELEMENT,null,!1),f=[];for(;u.nextNode();){const n=u.currentNode,i=n.tagName&&n.tagName.toLowerCase();if(o.has(i)){f.push(n);continue}const a=Array.from(n.attributes||[]);for(const m of a){const l=m.name.toLowerCase(),r=(m.value||"").toLowerCase();if(l.startsWith("on")){n.removeAttribute(m.name);continue}if(l.startsWith("data-")){n.removeAttribute(m.name);continue}if(l==="style"){n.removeAttribute("style");continue}if((l==="href"||l==="src"||l==="xlink:href")&&/^\s*(javascript:|data:text\/html)/i.test(r)){n.removeAttribute(m.name);continue}if(l==="srcset")try{const s=m.value.split(",").map(c=>c.trim()).filter(c=>!/^\s*(javascript:|data:text\/html)/i.test(c.toLowerCase()));s.length?n.setAttribute("srcset",s.join(", ")):n.removeAttribute("srcset")}catch{n.removeAttribute("srcset")}if((l==="action"||l==="formaction")&&/^\s*(javascript:|data:text\/html)/i.test(r)){n.removeAttribute(m.name);continue}}}for(const n of f)n&&n.parentNode&&n.parentNode.removeChild(n);return t.innerHTML}function K(e,t){return e?t==="off"?e:t==="moderate"?_(e):t==="aggressive"?q(e):e:""}function V(){const e=h.value||"";let t=e;if(/[&][a-zA-Z0-9#]+;/.test(e)&&!/<[a-z][\s\S]*>/i.test(e))try{const u=document.createElement("div");u.innerHTML=e,t=u.innerHTML}catch{t=e}const o=A.value||"moderate";if(o==="off")return t;try{return K(t,o)}catch{return t}}function $(e){try{v.style.display="",C.style.display="none";const o=`
        <!doctype html>
        <html lang="en">
        <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width,initial-scale=1">
          <style>
            :root{color-scheme:light dark;}
            html,body{margin:0;padding:12px;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:transparent;color:inherit;}
            img{max-width:100%;height:auto;border-radius:6px;}
            table{border-collapse:collapse;width:100%;}
            code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono",monospace;font-size:0.92em;}
          </style>
        </head>
        <body>${(e||"").trim()||'<div class="html-entity-preview-empty">(Nothing to preview)</div>'}</body>
        </html>
      `;v.srcdoc=o,v.onload=()=>{}}catch{v.style.display="none",C.style.display="",C.textContent=e||"(Nothing to preview)"}M()}function U(e){v.style.display="none",C.style.display="",C.textContent=e||"";try{v.srcdoc="",v.removeAttribute("src")}catch{}M()}function M(){const e=A.value||"moderate",t=`Sanitization: ${e.charAt(0).toUpperCase()+e.slice(1)} — preview is sandboxed.`;W.textContent=t}function b(){if(!k)return;const e=V();T==="render"?$(e):U(e)}w.addEventListener("keydown",e=>{(navigator.platform.toLowerCase().includes("mac")?e.metaKey:e.ctrlKey)&&(e.key.toLowerCase()==="e"?(e.preventDefault(),g.click()):e.key.toLowerCase()==="d"?(e.preventDefault(),E.click()):e.key.toLowerCase()==="k"?(e.preventDefault(),P.click()):e.shiftKey&&e.key.toLowerCase()==="c"&&(e.preventDefault(),j.click()))},!0);function O(){if(g.classList.contains("active")){const e=!!x.checked;p.value=S(h.value,{toNumericNonAscii:e}),y("Live encoding…")}else E.classList.contains("active")?(p.value=D(h.value),y("Live decoding…")):(p.value="",y(""));b()}h.addEventListener("input",O);function H(e){[g,E].forEach(t=>t.classList.remove("active")),e&&e.classList.add("active"),O()}N.addEventListener("click",()=>{k?(T=T==="render"?"escaped":"render",N.textContent=T==="render"?"Show Escaped":"Show Rendered",b()):(k=!0,T="render",N.textContent="Show Escaped",b())}),p.addEventListener("input",b),p.addEventListener("change",b),A.addEventListener("change",()=>{M(),b()}),x.addEventListener("change",()=>{g.classList.contains("active")&&(p.value=S(h.value,{toNumericNonAscii:!!x.checked}),b())}),g.addEventListener("click",e=>{H(g);const t=e.shiftKey===!0||x.checked;p.value=S(h.value,{toNumericNonAscii:!!t}),y(t?"Encoded (non-ASCII → numeric entities).":"Encoded!"),b()}),E.addEventListener("click",()=>{H(E),p.value=D(h.value),y("Decoded!"),b()}),P.addEventListener("click",()=>{h.value="",p.value="",y("Cleared.",!0),[g,E].forEach(e=>e.classList.remove("active")),v.style.display="none",C.style.display="none";try{v.srcdoc="",v.removeAttribute("src")}catch{}k=!1,N.textContent="Show Preview"}),j.addEventListener("click",async()=>{await R(p.value||"")?y("Output copied!",!0):y("Copy failed.",!1)}),p.addEventListener("focus",()=>{try{p.select()}catch{}}),H(g),A.value="moderate",T="render",M(),y("Ready. Sanitization: Moderate by default. Single-click preview toggle switches modes. Preview is sandboxed.",!0,9e3)}function J(w,d){X(w),G(w)}export{J as load,X as loadHTMLEntityTool,G as setupHTMLEntityTool};
